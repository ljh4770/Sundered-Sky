library(dplyr)
library(magrittr)
library(tidyverse)
library(data.table)
library(ggplot2)
library(lubridate)
library(gridExtra)
library(astsa)



setwd(getwd())
######################### EDA2 #########################
##Humid + alpha EDA codes 


train <- fread("../data/train_prepro.csv")

## ?Ȱ??߻? ???? ????

#?⵵?? ?Ȱ??? ?? ???̳? ?߻??ߴ???
train %>%
  group_by(stn_id, year, month, day) %>%
  summarise(fogyn = mean(class)) %>%
  mutate(fogyn = ifelse(fogyn<4, 1, 0)) %>%
  filter(fogyn == 1) %>%
  summarise(n = n()) %>%
  summarise(n = sum(n)) -> summary_year_fogyn

summary_year_fogyn %>%  
  ggplot(aes(x = as.factor(year), y = n)) +
  geom_point() +
  geom_line(aes(group = stn_id, color = stn_id))

#?????? ???? ????�� ?ϼ??? ?????? ??�� ?????? 
#?׷??? ??�� ????(DA, BA, BD, CA, AH)?? ?ִٴ? ??�� Ȯ???ߴ?. 
#?׷????? ?? ?⵵ ???? ?????? ū ???̸? ???̴? ?????? ��???ϴµ? ?̰??? ?????? ?????????? ?ľ??ϴ? ???? ?߿??? ?? ????. ?׷??? ��?ؼ??? ???????? ȿ???? ???? ?��??ϹǷ? ��?? ?׷??��? ?? ?⵵???? ?????? ?? ??��?? ???캸??.

train %>%
  group_by(stn_id, year, month, day) %>%
  summarise(fogyn = mean(class)) %>%
  mutate(fogyn = ifelse(fogyn < 4, 1, 0)) %>%
  summarise(n = sum(fogyn)) -> summary_month_fogyn
head(summary_month_fogyn)

#???????? ?׷??��? ?????? ????�� ?ִ? ???찡 ?ֱ? ?????? aggregate?ؼ? ?ٷ? ?? ???? ?? ?⵵???? ???? ?Ȱ? ?߻? ?ϼ??? üũ?ؾ???.

summary_month_fogyn %>%
  spread(month, n) -> table_month_fogyn
head(table_month_fogyn)

summary_month_fogyn %>%
  filter(year == 'I') %>%
  ggplot(aes(x = month, y = n)) +
  geom_point() +
  geom_line(aes(group = stn_id, color = stn_id))

table_month_fogyn %>%
  filter(year == 'I') %>%
  as.tibble()

summary_month_fogyn %>%
  filter(year == 'J') %>%
  ggplot(aes(x = month, y = n)) +
  geom_point() +
  geom_line(aes(group = stn_id, color = stn_id))

table_month_fogyn %>%
  filter(year == 'J') %>%
  as.tibble()

summary_month_fogyn %>%
  filter(year == 'K') %>%
  ggplot(aes(x = month, y = n)) +
  geom_point() +
  geom_line(aes(group = stn_id, color = stn_id))
table_month_fogyn %>%
  filter(year == 'K') %>%
  as.tibble()

## ?ð??뺰 ?Ȱ? ?߻? ????
train %>%
  group_by(stn_id, time, year, month, day) %>%
  summarise(fogyn = mean(class)) %>%
  mutate(fogyn = ifelse(fogyn < 4, 1, 0)) %>%
  summarise(n = sum(fogyn)) -> summary_time_fogyn
head(summary_time_fogyn)  

summary_time_fogyn %>%
  summarise(n = sum(n)) %>%
  ggplot(aes()) +
  geom_bar(aes(x = as.factor(time), y = n), stat = 'identity')

#?Ȱ??? ?ַ? 4?ÿ??? 7?ñ??? ??ħ?? ?߻??ϴ? ??�� ?? ?? ?ִ?. ?????? ???? ?ذ? ?ߴ? ?ð??? ?޶????Ƿ? ??�� ??��?Ͽ? ?׷??��? ?ٽ? ?׷��???.

# ?????��?
train %>%
  filter(hm > 0) %>%
  ggplot(aes(x = hm)) +
  geom_density() +
  theme_classic()

train %>%
  select(hm, year, month, day, time, minute, stn_id, ts) %>%
  filter(hm > 0) -> df.lm1



HT.lm1 <- lm(hm ~ year + as.factor(month) +as.factor(time) + stn_id + ts,data = df.lm1)

summary(HT.lm1)

#?⵵?? ?? ?ð?�� ??��?ϰ? ??�� ?????? ��?Լ?�� ??��?Ѵ?.
hist(HT.lm1$residuals)
library(moments)
c('Mean' = mean(HT.lm1$residuals), 'Var' = var(HT.lm1$residuals),
  'Skeness' = skewness(HT.lm1$residuals),'Kurotosis' = kurtosis(HT.lm1$residuals)) -> table_hm
table_hm